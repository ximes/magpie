(function(){var e=function(e,t){return function(){return e.apply(t,arguments)}};window.RecurringSelectDialog=function(){function t(t){this.recurring_selector=t,this.weekOfMonthChanged=e(this.weekOfMonthChanged,this),this.dateOfMonthChanged=e(this.dateOfMonthChanged,this),this.daysChanged=e(this.daysChanged,this),this.intervalChanged=e(this.intervalChanged,this),this.freqChanged=e(this.freqChanged,this),this.toggle_month_view=e(this.toggle_month_view,this),this.init_calendar_weeks=e(this.init_calendar_weeks,this),this.init_calendar_days=e(this.init_calendar_days,this),this.summaryFetchSuccess=e(this.summaryFetchSuccess,this),this.summaryUpdate=e(this.summaryUpdate,this),this.save=e(this.save,this),this.outerCancel=e(this.outerCancel,this),this.cancel=e(this.cancel,this),this.positionDialogVert=e(this.positionDialogVert,this),this.current_rule=this.recurring_selector.recurring_select("current_rule"),this.initDialogBox(),null==this.current_rule.hash||null==this.current_rule.hash.rule_type?this.freqChanged():setTimeout(this.positionDialogVert,10)}return t.prototype.initDialogBox=function(){var e;return $(".rs_dialog_holder").remove(),e=$("body"),$(".ui-page-active").length&&(e=$(".ui-page-active")),e.append(this.template()),this.outer_holder=$(".rs_dialog_holder"),this.inner_holder=this.outer_holder.find(".rs_dialog"),this.content=this.outer_holder.find(".rs_dialog_content"),this.positionDialogVert(!0),this.mainEventInit(),this.freqInit(),this.summaryInit(),this.outer_holder.trigger("recurring_select:dialog_opened"),this.freq_select.focus()},t.prototype.positionDialogVert=function(e){var t,r,n,s;return s=$(window).height(),$(window).width(),t=this.content.outerHeight(),t<80&&(t=80),r=(s-t)/2-30,r<10&&(r=10),n={"margin-top":r+"px","min-height":t+"px"},null!=e?(this.inner_holder.css(n),this.inner_holder.trigger("recurring_select:dialog_positioned")):(this.inner_holder.addClass("animated"),this.inner_holder.animate(n,200,function(e){return function(){return e.inner_holder.removeClass("animated"),e.content.css({width:"auto"}),e.inner_holder.trigger("recurring_select:dialog_positioned")}}(this)))},t.prototype.cancel=function(){return this.outer_holder.remove(),this.recurring_selector.recurring_select("cancel")},t.prototype.outerCancel=function(e){if($(e.target).hasClass("rs_dialog_holder"))return this.cancel()},t.prototype.save=function(){if(null!=this.current_rule.str)return this.outer_holder.remove(),this.recurring_selector.recurring_select("save",this.current_rule)},t.prototype.mainEventInit=function(){return this.outer_holder.on("click tap",this.outerCancel),this.content.on("click tap","h1 a",this.cancel),this.save_button=this.content.find("input.rs_save").on("click tap",this.save),this.content.find("input.rs_cancel").on("click tap",this.cancel)},t.prototype.freqInit=function(){var e;return this.freq_select=this.outer_holder.find(".rs_frequency"),null!=this.current_rule.hash&&null!=(e=this.current_rule.hash.rule_type)&&(-1!==e.search(/Weekly/)?(this.freq_select.prop("selectedIndex",1),this.initWeeklyOptions()):-1!==e.search(/Monthly/)?(this.freq_select.prop("selectedIndex",2),this.initMonthlyOptions()):-1!==e.search(/Yearly/)?(this.freq_select.prop("selectedIndex",3),this.initYearlyOptions()):this.initDailyOptions()),this.freq_select.on("change",this.freqChanged)},t.prototype.initDailyOptions=function(){var e,t;return t=this.content.find(".daily_options"),e=t.find(".rs_daily_interval"),e.val(this.current_rule.hash.interval),e.on("change keyup",this.intervalChanged),t.show()},t.prototype.initWeeklyOptions=function(){var e,t;return t=this.content.find(".weekly_options"),e=t.find(".rs_weekly_interval"),e.val(this.current_rule.hash.interval),e.on("change keyup",this.intervalChanged),t.find(".day_holder a").each(function(e,t){return $(t).removeClass("selected")}),null!=this.current_rule.hash.validations&&null!=this.current_rule.hash.validations.day&&$(this.current_rule.hash.validations.day).each(function(e,r){return t.find(".day_holder a[data-value='"+r+"']").addClass("selected")}),t.off("click",".day_holder a").on("click",".day_holder a",this.daysChanged),t.show()},t.prototype.initMonthlyOptions=function(){var e,t,r,n,s,i;return i=this.content.find(".monthly_options"),s=i.find(".rs_monthly_interval"),s.val(this.current_rule.hash.interval),s.on("change keyup",this.intervalChanged),(e=this.current_rule.hash).validations||(e.validations={}),(t=this.current_rule.hash.validations).day_of_month||(t.day_of_month=[]),(r=this.current_rule.hash.validations).day_of_week||(r.day_of_week={}),this.init_calendar_days(i),this.init_calendar_weeks(i),n=Object.keys(this.current_rule.hash.validations.day_of_week).length>0,i.find(".monthly_rule_type_week").prop("checked",n),i.find(".monthly_rule_type_day").prop("checked",!n),this.toggle_month_view(),i.find("input[name=monthly_rule_type]").on("change",this.toggle_month_view),i.show()},t.prototype.initYearlyOptions=function(){var e,t;return t=this.content.find(".yearly_options"),e=t.find(".rs_yearly_interval"),e.val(this.current_rule.hash.interval),e.on("change keyup",this.intervalChanged),t.show()},t.prototype.summaryInit=function(){return this.summary=this.outer_holder.find(".rs_summary"),this.summaryUpdate()},t.prototype.summaryUpdate=function(){var e;return this.summary.width(this.content.width()),null!=this.current_rule.hash&&null!=this.current_rule.str?(this.summary.removeClass("fetching"),this.save_button.removeClass("disabled"),e=this.current_rule.str.replace("*",""),e.length<20&&(e=$.fn.recurring_select.texts.summary+": "+e),this.summary.find("span").html(e)):(this.summary.addClass("fetching"),this.save_button.addClass("disabled"),this.summary.find("span").html(""),this.summaryFetch())},t.prototype.summaryFetch=function(){if(null!=this.current_rule.hash&&null!=this.current_rule.hash.rule_type)return this.current_rule.hash.week_start=$.fn.recurring_select.texts.first_day_of_week,$.ajax({url:"/recurring_select/translate/"+$.fn.recurring_select.texts.locale_iso_code,type:"POST",data:this.current_rule.hash,success:this.summaryFetchSuccess})},t.prototype.summaryFetchSuccess=function(e){return this.current_rule.str=e,this.summaryUpdate(),this.content.css({width:"auto"})},t.prototype.init_calendar_days=function(e){var t,r,n,s,i;for(s=e.find(".rs_calendar_day"),s.html(""),i=n=1;n<=31;i=++n)s.append(t=$(document.createElement("a")).text(i)),-1!==$.inArray(i,this.current_rule.hash.validations.day_of_month)&&t.addClass("selected");return s.append(r=$(document.createElement("a")).text($.fn.recurring_select.texts.last_day)),r.addClass("end_of_month"),-1!==$.inArray(-1,this.current_rule.hash.validations.day_of_month)&&r.addClass("selected"),s.find("a").on("click tap",this.dateOfMonthChanged)},t.prototype.init_calendar_weeks=function(e){var t,r,n,s,i,a,l,h,c,o,u,_,d,p;for(h=e.find(".rs_calendar_week"),h.html(""),d=$.fn.recurring_select.texts.order,p=$.fn.recurring_select.options.monthly.show_week,t=$.fn.recurring_select.texts.days_first_letter,o=[1,2,3,4,5,-1],i=s=0,l=o.length;s<l;i=++s)if(c=o[i],p[i])for(h.append("<span>"+d[c-1]+"</span>"),n=a=u=$.fn.recurring_select.texts.first_day_of_week,_=7+$.fn.recurring_select.texts.first_day_of_week;u<=_?a<_:a>_;n=u<=_?++a:--a)n%=7,r=$("<a>",{text:t[n]}),r.attr("day",n),r.attr("instance",c),h.append(r);return $.each(this.current_rule.hash.validations.day_of_week,function(t,r){return $.each(r,function(r,n){return e.find("a[day='"+t+"'][instance='"+n+"']").addClass("selected")})}),h.find("a").on("click tap",this.weekOfMonthChanged)},t.prototype.toggle_month_view=function(){var e;return e=this.content.find(".monthly_rule_type_week").prop("checked"),this.content.find(".rs_calendar_week").toggle(e),this.content.find(".rs_calendar_day").toggle(!e)},t.prototype.freqChanged=function(){var e;switch($.isPlainObject(this.current_rule.hash)||(this.current_rule.hash=null),(e=this.current_rule).hash||(e.hash={}),this.current_rule.hash.interval=1,this.current_rule.hash.until=null,this.current_rule.hash.count=null,this.current_rule.hash.validations=null,this.content.find(".freq_option_section").hide(),this.content.find("input[type=radio], input[type=checkbox]").prop("checked",!1),this.freq_select.val()){case"Weekly":this.current_rule.hash.rule_type="IceCube::WeeklyRule",this.current_rule.str=$.fn.recurring_select.texts.weekly,this.initWeeklyOptions();break;case"Monthly":this.current_rule.hash.rule_type="IceCube::MonthlyRule",this.current_rule.str=$.fn.recurring_select.texts.monthly,this.initMonthlyOptions();break;case"Yearly":this.current_rule.hash.rule_type="IceCube::YearlyRule",this.current_rule.str=$.fn.recurring_select.texts.yearly,this.initYearlyOptions();break;default:this.current_rule.hash.rule_type="IceCube::DailyRule",this.current_rule.str=$.fn.recurring_select.texts.daily,this.initDailyOptions()}return this.summaryUpdate(),this.positionDialogVert()},t.prototype.intervalChanged=function(e){var t;return this.current_rule.str=null,(t=this.current_rule).hash||(t.hash={}),this.current_rule.hash.interval=parseInt($(e.currentTarget).val()),(this.current_rule.hash.interval<1||isNaN(this.current_rule.hash.interval))&&(this.current_rule.hash.interval=1),this.summaryUpdate()},t.prototype.daysChanged=function(e){var t,r;return $(e.currentTarget).toggleClass("selected"),this.current_rule.str=null,(t=this.current_rule).hash||(t.hash={}),this.current_rule.hash.validations={},r=this.content.find(".day_holder a.selected").map(function(){return parseInt($(this).data("value"))}),this.current_rule.hash.validations.day=r.get(),this.summaryUpdate(),!1},t.prototype.dateOfMonthChanged=function(e){var t,r;return $(e.currentTarget).toggleClass("selected"),this.current_rule.str=null,(t=this.current_rule).hash||(t.hash={}),this.current_rule.hash.validations={},r=this.content.find(".monthly_options .rs_calendar_day a.selected").map(function(){return $(this).text()===$.fn.recurring_select.texts.last_day?-1:parseInt($(this).text())}),this.current_rule.hash.validations.day_of_week={},this.current_rule.hash.validations.day_of_month=r.get(),this.summaryUpdate(),!1},t.prototype.weekOfMonthChanged=function(e){var t;return $(e.currentTarget).toggleClass("selected"),this.current_rule.str=null,(t=this.current_rule).hash||(t.hash={}),this.current_rule.hash.validations={},this.current_rule.hash.validations.day_of_month=[],this.current_rule.hash.validations.day_of_week={},this.content.find(".monthly_options .rs_calendar_week a.selected").each(function(e){return function(t,r){var n,s,i;return s=parseInt($(r).attr("day")),i=parseInt($(r).attr("instance")),(n=e.current_rule.hash.validations.day_of_week)[s]||(n[s]=[]),e.current_rule.hash.validations.day_of_week[s].push(i)}}(this)),this.summaryUpdate(),!1},t.prototype.template=function(){var e,t,r,n,s;for(s="<div class='rs_dialog_holder'> <div class='rs_dialog'> <div class='rs_dialog_content'> <h1>"+$.fn.recurring_select.texts.repeat+" <a href='#' title='"+$.fn.recurring_select.texts.cancel+"' Alt='"+$.fn.recurring_select.texts.cancel+"'></a> </h1> <p class='frequency-select-wrapper'> <label for='rs_frequency'>"+$.fn.recurring_select.texts.frequency+":</label> <select data-wrapper-class='ui-recurring-select' id='rs_frequency' class='rs_frequency' name='rs_frequency'> <option value='Daily'>"+$.fn.recurring_select.texts.daily+"</option> <option value='Weekly'>"+$.fn.recurring_select.texts.weekly+"</option> <option value='Monthly'>"+$.fn.recurring_select.texts.monthly+"</option> <option value='Yearly'>"+$.fn.recurring_select.texts.yearly+"</option> </select> </p> <div class='daily_options freq_option_section'> <p> "+$.fn.recurring_select.texts.every+" <input type='text' data-wrapper-class='ui-recurring-select' name='rs_daily_interval' class='rs_daily_interval rs_interval' value='1' size='2' /> "+$.fn.recurring_select.texts.days+" </p> </div> <div class='weekly_options freq_option_section'> <p> "+$.fn.recurring_select.texts.every+" <input type='text' data-wrapper-class='ui-recurring-select' name='rs_weekly_interval' class='rs_weekly_interval rs_interval' value='1' size='2' /> "+$.fn.recurring_select.texts.weeks_on+": </p> <div class='day_holder'>",e=t=r=$.fn.recurring_select.texts.first_day_of_week,n=7+$.fn.recurring_select.texts.first_day_of_week;r<=n?t<n:t>n;e=r<=n?++t:--t)e%=7,s+="<a href='#' data-value='"+e+"'>"+$.fn.recurring_select.texts.days_first_letter[e]+"</a>";return s+="</div> <span style='clear:both; visibility:hidden; height:1px;'>.</span> </div> <div class='monthly_options freq_option_section'> <p> "+$.fn.recurring_select.texts.every+" <input type='text' data-wrapper-class='ui-recurring-select' name='rs_monthly_interval' class='rs_monthly_interval rs_interval' value='1' size='2' /> "+$.fn.recurring_select.texts.months+": </p> <p class='monthly_rule_type'> <span><label for='monthly_rule_type_day'>"+$.fn.recurring_select.texts.day_of_month+"</label><input type='radio' class='monthly_rule_type_day' name='monthly_rule_type' id='monthly_rule_type_day' value='true' /></span> <span><label for='monthly_rule_type_week'>"+$.fn.recurring_select.texts.day_of_week+"</label><input type='radio' class='monthly_rule_type_week' name='monthly_rule_type' id='monthly_rule_type_week' value='true' /></span> </p> <p class='rs_calendar_day'></p> <p class='rs_calendar_week'></p> </div> <div class='yearly_options freq_option_section'> <p> "+$.fn.recurring_select.texts.every+" <input type='text' data-wrapper-class='ui-recurring-select' name='rs_yearly_interval' class='rs_yearly_interval rs_interval' value='1' size='2' /> "+$.fn.recurring_select.texts.years+" </p> </div> <p class='rs_summary'> <span></span> </p> <div class='controls'> <input type='button' data-wrapper-class='ui-recurring-select' class='rs_save' value='"+$.fn.recurring_select.texts.ok+"' /> <input type='button' data-wrapper-class='ui-recurring-select' class='rs_cancel' value='"+$.fn.recurring_select.texts.cancel+"' /> </div> </div> </div> </div>"},t}()}).call(this);